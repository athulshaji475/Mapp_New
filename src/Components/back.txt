import React, { useRef, useState, useEffect } from 'react';
import { GoogleMap, LoadScript, Marker, Polyline, DirectionsService, DirectionsRenderer } from '@react-google-maps/api';
import { Timeline, TimelineEvent } from 'react-event-timeline';
import moment from 'moment';

const containerStyle = {
  width: '100%',
  height: '70vh',
};

const center = {
  lat: -3.745,
  lng: -38.523,
};

function Map() {
  const mapRef = useRef(null);

  const [currentLocation, setCurrentLocation] = useState(null);
  const [locations, setLocations] = useState([]);
  const [apiLoaded, setApiLoaded] = useState(false);
  const [calcArea, setCalcArea] = useState(0);
  const [isCalculating, setIsCalculating] = useState(false);
  const [showArea, setShowArea] = useState(false);
  const [polylinePath, setPolylinePath] = useState([]);
  const [fromLocation, setFromLocation] = useState('');
  const [toLocation, setToLocation] = useState('');
  const [directions, setDirections] = useState(null);
  const [selectedEvent, setSelectedEvent] = useState(null);

  const handleMapClick = (event) => {
    if (!isCalculating) {
      const clickedLocation = {
        lat: event.latLng.lat(),
        lng: event.latLng.lng(),
        time: moment().format('YYYY-MM-DD HH:mm:ss'),
      };

      setLocations((prevLocations) => [...prevLocations, clickedLocation]);
    }
  };

  const calculatePolygonArea = () => {
    if (!apiLoaded) {
      console.log('Google Maps API is still loading. Please wait.');
      return;
    }

    if (locations.length < 3) {
      console.log('At least 3 locations are required to calculate the area.');
      return;
    }

    const googleMaps = window.google.maps;

    const polygonPath = locations.map((location) => new googleMaps.LatLng(location.lat, location.lng));
    const polygon = new googleMaps.Polygon({ paths: polygonPath });

    const area = googleMaps.geometry.spherical.computeArea(polygon.getPath());
    setCalcArea(area);
    setShowArea(true);
    console.log('Polygon area:', area);
  };

  const handleSearch = () => {
    if (!apiLoaded) {
      console.log('Google Maps API is still loading. Please wait.');
      return;
    }

    const googleMaps = window.google.maps;
    const geocoder = new googleMaps.Geocoder();

    geocoder.geocode({ address: fromLocation }, (results, status) => {
      if (status === googleMaps.GeocoderStatus.OK) {
        const { lat, lng } = results[0].geometry.location;
        setCurrentLocation({ lat: lat(), lng: lng() });
      } else {
        console.log('Geocode was not successful for the following reason:', status);
      }
    });

    geocoder.geocode({ address: toLocation }, (results, status) => {
      if (status === googleMaps.GeocoderStatus.OK) {
        const { lat, lng } = results[0].geometry.location;
        setToLocation({ lat: lat(), lng: lng() });
      } else {
        console.log('Geocode was not successful for the following reason:', status);
      }
    });
  };

  const handleStart = () => {
    if (fromLocation && toLocation) {
      const directionsService = new window.google.maps.DirectionsService();

      directionsService.route(
        {
          origin: fromLocation,
          destination: toLocation,
          travelMode: window.google.maps.TravelMode.DRIVING,
        },
        (result, status) => {
          if (status === window.google.maps.DirectionsStatus.OK) {
            setDirections(result);
          } else {
            console.error('Directions request failed:', status);
          }
        }
      );
    }
  };

  const handleLoad = () => {
    setApiLoaded(true);
  };

  useEffect(() => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          setCurrentLocation({ lat: latitude, lng: longitude });
        },
        (error) => {
          console.log('Error retrieving location:', error);
        }
      );
    } else {
      console.log('Geolocation is not supported by this browser.');
    }
  }, []);

  return (
    <div style={{ height: '100%' }}>
      <div style={{ display: 'flex', justifyContent: 'center' }}>
        <input
          type='text'
          className='form-control'
          placeholder='From'
          value={fromLocation}
          onChange={(e) => setFromLocation(e.target.value)}
        />
        <input
          type='text'
          className='form-control'
          placeholder='To'
          value={toLocation}
          onChange={(e) => setToLocation(e.target.value)}
        />
        <button className='btn btn-danger' onClick={handleSearch}>
          Search
        </button>
      </div>
      <div style={{ display: 'flex', justifyContent: 'center', margin: '10px' }}>
        <LoadScript
          googleMapsApiKey='AIzaSyBEKSlBoYpYsCEf1nOk5GprL87pMz7ZMp8'
          libraries={['places', 'geometry']}
          onLoad={handleLoad}
        >
          <GoogleMap
            ref={mapRef}
            mapContainerStyle={containerStyle}
            center={currentLocation || center}
            zoom={10}
            onClick={handleMapClick}
          >
            {currentLocation && <Marker position={currentLocation} />}
            {locations.map((event, index) => (
              <Marker key={index} position={event} />
            ))}
            {polylinePath.length > 0 && <Polyline path={polylinePath} options={{ strokeColor: '#FF0000' }} />}
            {directions && <DirectionsRenderer directions={directions} />}
            {fromLocation && <Marker position={fromLocation} />}
            {toLocation && <Marker position={toLocation} />}
          </GoogleMap>
        </LoadScript>
      </div>
      <div style={{ display: 'flex', justifyContent: 'center' }}>
        <button className='btn btn-success' onClick={calculatePolygonArea}>
          Calculate Area
        </button>
      </div>
      {showArea && (
        <div style={{ backgroundColor
          : 'lightcyan', marginTop: '10px', padding: '10px' }}>
          <h5>Calculated Area:</h5>
          <div>{calcArea} square meters</div>
        </div>
      )}
      <div style={{ display: 'flex', justifyContent: 'center' }}>
        <button
          className='btn btn-primary'
          style={{ width: '200px', marginTop: '10px' }}
          onClick={handleStart}
          disabled={!fromLocation || !toLocation}
        >
          Start Navigation
        </button>
      </div>
      <div style={{ display: 'flex', justifyContent: 'center', marginTop: '20px' }}>
        <Timeline lineStyle={{ background: '#ddd', width: '2px' }}>
          {locations.map((event, index) => (
            <TimelineEvent
              key={index}
              title={moment(event.time).format('YYYY-MM-DD HH:mm:ss')}
              icon={<i className='fa fa-map-marker' />}
              bubbleStyle={{ border: '2px solid #007bff' }}
              iconStyle={{ background: '#007bff', color: '#fff' }}
              container='card'
              cardHeaderStyle={{ background: '#007bff', color: '#fff' }}
              cardBodyStyle={{ background: '#f8f9fa' }}
              onClick={() => setSelectedEvent(event)}
              selected={selectedEvent === event}
            >
              <div>Lat: {event.lat}</div>
              <div>Lng: {event.lng}</div>
            </TimelineEvent>
          ))}
        </Timeline>
      </div>
    </div>
  );
}

export default Map;
